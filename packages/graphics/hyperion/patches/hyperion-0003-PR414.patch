From 624fe6c429aee896b150d23289f0be19e040474d Mon Sep 17 00:00:00 2001
From: tociek <jacek@lightberry.eu>
Date: Thu, 12 Nov 2015 00:22:11 +0100
Subject: [PATCH 1/3] Corrected APA102 USB (adalight) led device

I have removed the 'hack' that allowed to use APA102 with original
version of adalight. I have modified adalight code and placed it into
dependencies folder. This change is not backward compatible, so it won't
work with original adalight code.
The reason for the change is that last leds were not acting as they
should (last led red). Additionally with this change and new arduino
code, performance is  lot better and lights change much smoother.
I have also changed switchOff method that requires different data sent
to apa102 to turn all leds off.

Enjoy :)
Jacek
---
 dependencies/LightberryHDUSBAPA1021.1.zip    | Bin 0 -> 4443 bytes
 libsrc/leddevice/LedDeviceAdalightApa102.cpp |  35 ++++++++++++++++++++-------
 libsrc/leddevice/LedDeviceAdalightApa102.h   |   8 ++++--
 3 files changed, 32 insertions(+), 11 deletions(-)
 create mode 100644 dependencies/LightberryHDUSBAPA1021.1.zip

diff --git a/dependencies/LightberryHDUSBAPA1021.1.zip b/dependencies/LightberryHDUSBAPA1021.1.zip
new file mode 100644
index 0000000000000000000000000000000000000000..13c743a080b77d837e04beb6a62e7e210ae984bc
GIT binary patch
literal 4443
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
PdnNi~9{quczdrXr;VLB$

literal 0
HcmV?d00001

diff --git a/libsrc/leddevice/LedDeviceAdalightApa102.cpp b/libsrc/leddevice/LedDeviceAdalightApa102.cpp
index 0773208..5f5cc42 100644
--- a/libsrc/leddevice/LedDeviceAdalightApa102.cpp
+++ b/libsrc/leddevice/LedDeviceAdalightApa102.cpp
@@ -3,7 +3,6 @@
 #include <cstring>
 #include <cstdio>
 #include <iostream>
-#include <algorithm>
 
 // Linux includes
 #include <fcntl.h>
@@ -18,24 +17,23 @@ LedDeviceAdalightApa102::LedDeviceAdalightApa102(const std::string& outputDevice
 	_timer()
 {
 }
-//comparing to ws2801 adalight, the following changes were needed:
-// 1- differnt data frame (4 bytes instead of 3)
-// 2 - in order to accomodate point 1 above, number of leds sent to adalight is increased by 1/3rd
+// see dependencies folder for arduino sketch for APA102
 int LedDeviceAdalightApa102::write(const std::vector<ColorRgb> & ledValues)
 {
+	ledCount = ledValues.size();
 	const unsigned int startFrameSize = 4;
 	const unsigned int endFrameSize = std::max<unsigned int>(((ledValues.size() + 15) / 16), 4);
 	const unsigned int mLedCount = (ledValues.size() * 4) + startFrameSize + endFrameSize;
-	if(_ledBuffer.size() != mLedCount){
-		_ledBuffer.resize(mLedCount, 0xFF);
+	if(_ledBuffer.size() != mLedCount+6){
+		_ledBuffer.resize(mLedCount+6, 0x00);
 		_ledBuffer[0] = 'A';
 		_ledBuffer[1] = 'd';
 		_ledBuffer[2] = 'a';
-		_ledBuffer[3] = (((unsigned int)(ledValues.size() * 1.33) - 1) >> 8) & 0xFF; // LED count high byte
-		_ledBuffer[4] = ((unsigned int)(ledValues.size() * 1.33) - 1) & 0xFF;        // LED count low byte
+		_ledBuffer[3] = (((unsigned int)(ledValues.size())) >> 8) & 0xFF; // LED count high byte
+		_ledBuffer[4] = ((unsigned int)(ledValues.size())) & 0xFF;        // LED count low byte
 		_ledBuffer[5] = _ledBuffer[3] ^ _ledBuffer[4] ^ 0x55; // Checksum
 	}
-	
+
 	for (unsigned iLed=1; iLed<=ledValues.size(); iLed++) {
 		const ColorRgb& rgb = ledValues[iLed-1];
 		_ledBuffer[iLed*4+6]   = 0xFF;
@@ -51,4 +49,23 @@ int LedDeviceAdalightApa102::write(const std::vector<ColorRgb> & ledValues)
 	return writeBytes(_ledBuffer.size(), _ledBuffer.data());
 }
 
+int LedDeviceAdalightApa102::switchOff()
+{
+	for (unsigned iLed=1; iLed<=ledCount; iLed++) {
+		_ledBuffer[iLed*4+6]   = 0xFF;
+		_ledBuffer[iLed*4+1+6] = 0x00;
+		_ledBuffer[iLed*4+2+6] = 0x00;
+		_ledBuffer[iLed*4+3+6] = 0x00;
+	}
+	// restart the timer
+	_timer.start();
+
+	// write data
+	return writeBytes(_ledBuffer.size(), _ledBuffer.data());
+}
+
+void LedDeviceAdalightApa102::rewriteLeds()
+{
+	writeBytes(_ledBuffer.size(), _ledBuffer.data());
+}
 
diff --git a/libsrc/leddevice/LedDeviceAdalightApa102.h b/libsrc/leddevice/LedDeviceAdalightApa102.h
index a0a7c89..0c4b502 100644
--- a/libsrc/leddevice/LedDeviceAdalightApa102.h
+++ b/libsrc/leddevice/LedDeviceAdalightApa102.h
@@ -32,13 +32,17 @@ class LedDeviceAdalightApa102 : public LedDeviceAdalight
 	/// @return Zero on succes else negative
 	///
 	virtual int write(const std::vector<ColorRgb> & ledValues);
+	virtual int switchOff();
 
 
-
+private slots:
+	/// Write the last data to the leds again
+	void rewriteLeds();
+	
 private:
 	/// The buffer containing the packed RGB values
 	std::vector<uint8_t> _ledBuffer;
-
+	unsigned int ledCount;
 	/// Timer object which makes sure that led data is written at a minimum rate
 	/// The Adalight device will switch off when it does not receive data at least
 	/// every 15 seconds

From 1952eaad1ddbea3ce23252bb1d9c96ba29d72184 Mon Sep 17 00:00:00 2001
From: tociek <jacek@lightberry.eu>
Date: Mon, 23 Nov 2015 21:47:04 +0100
Subject: [PATCH 2/3] Fix to the adalightapa102 firmware

Fix to the firmware when converter would require reconnect after 15
seconds of hyperion inactivity
---
 dependencies/LightberryHDUSBAPA1021.1.zip | Bin 4443 -> 4555 bytes
 1 file changed, 0 insertions(+), 0 deletions(-)

diff --git a/dependencies/LightberryHDUSBAPA1021.1.zip b/dependencies/LightberryHDUSBAPA1021.1.zip
index 13c743a080b77d837e04beb6a62e7e210ae984bc..45d92c04034381b43ff720b959060fccd2bb4217 100644
GIT binary patch
delta 4348
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

delta 4220
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
SBKD0OldBOL22&6K0000s@B<zI


From 7ebb72f503ad74a7768deedf648b9e84c0a7cf3c Mon Sep 17 00:00:00 2001
From: tociek <jacek@lightberry.eu>
Date: Sat, 28 Nov 2015 22:58:58 +0100
Subject: [PATCH 3/3] Performance fixes for adalightapa102

Adalightapa102 now inherits from RS232Device.
Due to bad initialization, previous CPU usage on RPI1 could reach 60%.
ON RPi2 20%. Now its about 3% with grabber in use.
---
 libsrc/leddevice/LedDeviceAdalightApa102.cpp | 21 ++++++++++++++++-----
 libsrc/leddevice/LedDeviceAdalightApa102.h   |  4 ++--
 2 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/libsrc/leddevice/LedDeviceAdalightApa102.cpp b/libsrc/leddevice/LedDeviceAdalightApa102.cpp
index 5f5cc42..9cbd360 100644
--- a/libsrc/leddevice/LedDeviceAdalightApa102.cpp
+++ b/libsrc/leddevice/LedDeviceAdalightApa102.cpp
@@ -12,18 +12,27 @@
 #include "LedDeviceAdalightApa102.h"
 
 LedDeviceAdalightApa102::LedDeviceAdalightApa102(const std::string& outputDevice, const unsigned baudrate, int delayAfterConnect_ms) :
-	LedDeviceAdalight(outputDevice, baudrate, delayAfterConnect_ms),
+	LedRs232Device(outputDevice, baudrate, delayAfterConnect_ms),
 	_ledBuffer(0),
 	_timer()
 {
+	// setup the timer
+	_timer.setSingleShot(false);
+	_timer.setInterval(5000);
+	connect(&_timer, SIGNAL(timeout()), this, SLOT(rewriteLeds()));
+
+	// start the timer
+	_timer.start();
 }
-// see dependencies folder for arduino sketch for APA102
+//comparing to ws2801 adalight, the following changes were needed:
+// 1- differnt data frame (4 bytes instead of 3)
+// 2 - in order to accomodate point 1 above, number of leds sent to adalight is increased by 1/3rd
 int LedDeviceAdalightApa102::write(const std::vector<ColorRgb> & ledValues)
 {
 	ledCount = ledValues.size();
 	const unsigned int startFrameSize = 4;
-	const unsigned int endFrameSize = std::max<unsigned int>(((ledValues.size() + 15) / 16), 4);
-	const unsigned int mLedCount = (ledValues.size() * 4) + startFrameSize + endFrameSize;
+	const unsigned int endFrameSize = std::max<unsigned int>(((ledCount + 15) / 16), 4);
+	const unsigned int mLedCount = (ledCount * 4) + startFrameSize + endFrameSize;
 	if(_ledBuffer.size() != mLedCount+6){
 		_ledBuffer.resize(mLedCount+6, 0x00);
 		_ledBuffer[0] = 'A';
@@ -34,7 +43,7 @@ int LedDeviceAdalightApa102::write(const std::vector<ColorRgb> & ledValues)
 		_ledBuffer[5] = _ledBuffer[3] ^ _ledBuffer[4] ^ 0x55; // Checksum
 	}
 
-	for (unsigned iLed=1; iLed<=ledValues.size(); iLed++) {
+	for (unsigned iLed=1; iLed<=ledCount; iLed++) {
 		const ColorRgb& rgb = ledValues[iLed-1];
 		_ledBuffer[iLed*4+6]   = 0xFF;
 		_ledBuffer[iLed*4+1+6] = rgb.red;
@@ -57,11 +66,13 @@ int LedDeviceAdalightApa102::switchOff()
 		_ledBuffer[iLed*4+2+6] = 0x00;
 		_ledBuffer[iLed*4+3+6] = 0x00;
 	}
+	
 	// restart the timer
 	_timer.start();
 
 	// write data
 	return writeBytes(_ledBuffer.size(), _ledBuffer.data());
+	
 }
 
 void LedDeviceAdalightApa102::rewriteLeds()
diff --git a/libsrc/leddevice/LedDeviceAdalightApa102.h b/libsrc/leddevice/LedDeviceAdalightApa102.h
index 0c4b502..eef3766 100644
--- a/libsrc/leddevice/LedDeviceAdalightApa102.h
+++ b/libsrc/leddevice/LedDeviceAdalightApa102.h
@@ -7,12 +7,12 @@
 #include <QTimer>
 
 // hyperion incluse
-#include "LedDeviceAdalight.h"
+#include "LedRs232Device.h"
 
 ///
 /// Implementation of the LedDevice interface for writing to an Adalight led device for APA102.
 ///
-class LedDeviceAdalightApa102 : public LedDeviceAdalight
+class LedDeviceAdalightApa102 : public LedRs232Device
 {
 	Q_OBJECT
 
